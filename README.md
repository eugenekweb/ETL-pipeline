# ETL-процесс для банковских данных

## Описание проекта

Данный проект представляет собой полноценный ETL-процесс для обработки банковских данных с выявлением мошеннических операций. Проект реализует механизм SCD2 для исторических данных и включает в себя 4 типа проверок на мошенничество.

## Структура проекта

```
/
├── main.py                    # Главный файл для запуска
├── config.json               # Конфигурация проекта
├── requirements.txt           # Зависимости Python
├── py_scripts/               # Python модули
│   ├── etl_pipeline.py      # Основной ETL-процесс
│   ├── data_validation.py   # Валидация данных
│   ├── file_utils.py        # Работа с файлами
│   ├── db_utils.py          # Работа с базой данных
│   └── load_config.py       # Загрузка конфигурации
├── sql_scripts/              # SQL скрипты
│   ├── ddl/                 # Создание таблиц
│   │   └── create_tables.sql
│   └── dml/                 # Загрузка данных
│       ├── load_dimensions.sql
│       ├── load_facts.sql
│       └── build_fraud_report.sql
├── files/                    # Входные файлы данных
├── archive/                  # Архив обработанных файлов
└── logs/                     # Логи выполнения
```

## Требования

- Python 3.7+
- PostgreSQL
- pandas
- psycopg2
- sqlalchemy

## Установка зависимостей

```bash
pip install -r requirements.txt
```

## Настройка

1. **База данных**: Создайте базу данных PostgreSQL
2. **Конфигурация**: Отредактируйте `config.json`:
   ```json
   {
       "db": {
           "dbname": "your_db_name",
           "user": "your_username",
           "password": "your_password",
           "host": "localhost",
           "port": "5432"
       },
       "paths": {
           "files_dir": "files",
           "archive_dir": "archive",
           "ddl_sql": "sql_scripts/ddl",
           "dml_sql": "sql_scripts/dml"
       }
   }
   ```

3. **Создание таблиц**: Выполните SQL-скрипт `sql_scripts/ddl/create_tables.sql`

## Использование

### Запуск ETL-процесса

```bash
# Обработка данных за конкретную дату
python main.py 01032021

# Поддержка различных форматов даты
python main.py 01-03-2021
python main.py 01.03.2021
python main.py 01/03/2021

# С указанием конфигурационного файла
python main.py 01-03-2021 --config my_config.json
```

### Поддерживаемые форматы даты

Система автоматически преобразует различные форматы даты в стандартный `DDMMYYYY`:

| Формат | Пример | Описание |
|--------|--------|----------|
| `DDMMYYYY` | `01032021` | Стандартный формат (без изменений) |
| `DD-MM-YYYY` | `01-03-2021` | С дефисами |
| `DD.MM.YYYY` | `01.03.2021` | С точками |
| `DD/MM/YYYY` | `01/03/2021` | С слешами |
| `DD-MM-YY` | `01-03-21` | Двузначный год (автоматически +2000) |
| `DD.MM.YY` | `01.03.21` | Двузначный год (автоматически +2000) |

**Примечание**: Двузначные годы автоматически преобразуются в четырехзначные (например, `21` → `2021`).

## Типы мошеннических операций

Система выявляет 4 типа мошенничества:

1. **Операции при просроченном/заблокированном паспорте**
   - Просроченный паспорт
   - Паспорт в черном списке

2. **Операции при недействующем договоре**
   - Просроченный банковский счет

3. **Операции в разных городах в течение часа**
   - Подозрительная активность по одной карте

4. **Попытка подбора суммы**
   - 3+ отклоненные операции за 20 минут
   - Каждая последующая меньше предыдущей
   - Последняя успешная операция считается мошеннической

## Архитектура данных

### Staging таблицы
- `stg_transactions` - транзакции
- `stg_passport_blacklist` - черный список паспортов
- `stg_terminals` - терминалы

### Измерения (SCD2)
- `dwh_dim_clients_hist` - клиенты с историей изменений
- `dwh_dim_accounts_hist` - счета с историей изменений
- `dwh_dim_cards_hist` - карты с историей изменений
- `dwh_dim_terminals_hist` - терминалы с историей изменений

### Факты
- `dwh_fact_transactions` - транзакции
- `dwh_fact_passport_blacklist` - черный список паспортов

### Витрина
- `rep_fraud` - отчет по мошенничеству

## Особенности реализации

### SCD2 механизм
Все таблицы измерений используют механизм SCD2 (Slowly Changing Dimensions Type 2):
- `effective_from` - дата начала действия версии
- `effective_to` - дата окончания действия версии (дата-бесконечность для текущей версии)
- `deleted_flg` - флаг удаления (0 - активная, 1 - удаленная)

**Дата-бесконечность**: По умолчанию используется `9999-12-31`.

### Названия таблиц
Все таблицы используют нижний регистр для соответствия стандартам PostgreSQL.

### Гибкость ввода даты
Система автоматически распознает и преобразует различные форматы даты, что делает её удобной для пользователей.

## Логирование

Все операции логируются в:
- Консоль (stdout)
- Файл в директории `logs/`

## Обработка ошибок

- Валидация входных данных
- Проверка форматов файлов
- Обработка ошибок базы данных
- Архивирование файлов только после успешной обработки
- Автоматическое преобразование форматов даты

## Расширение функциональности

Для добавления новых типов мошенничества:
1. Добавьте логику в `build_fraud_report.sql`
2. Обновите валидацию в `data_validation.py`
3. Добавьте тесты

Для добавления новых форматов даты:
1. Обновите функцию `normalize_date` в `file_utils.py`
2. Добавьте соответствующие регулярные выражения

## Устранение неполадок

### Ошибка подключения к БД
- Проверьте настройки в `config.json`
- Убедитесь, что PostgreSQL запущен
- Проверьте права доступа пользователя

### Файлы не найдены
- Убедитесь, что файлы находятся в директории `files/`
- Проверьте формат именования файлов
- Проверьте права доступа к файлам

### Ошибки валидации
- Проверьте формат данных в файлах
- Убедитесь, что все обязательные поля присутствуют
- Проверьте соответствие типов данных

### Ошибки формата даты
- Убедитесь, что используете поддерживаемый формат
- Проверьте корректность значений дня, месяца и года
- Для двузначных годов система автоматически добавляет 2000

## Автор

Проект создан в рамках курса по дата-инжинирингу.

## Лицензия

Внутренний проект.
