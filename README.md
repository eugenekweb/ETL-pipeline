#### Ковалёв Евгений

#### Итоговая работа по курсу "SQL для прикладных задач"

#### МФТИ, курс «Data Engineer»

---

# ETL-процесс для банковских данных

## Описание проекта

Данный проект представляет собой полноценный ETL-процесс для обработки банковских данных с выявлением мошеннических операций. Проект реализует механизм SCD2 (Slowly Changing Dimensions Type 2) для исторических данных и включает в себя 4 типа проверок на мошенничество.

## Архитектура проекта

### Структура директорий

```
/
├── main.py                    # Точка входа в приложение
├── config.json               # Конфигурация подключения к БД
├── requirements.txt          # Зависимости Python
├── py_scripts/              # Python модули
│   ├── etl_pipeline.py      # Основной ETL-процесс
│   ├── file_utils.py        # Утилиты для работы с файлами
│   ├── db_utils.py          # Утилиты для работы с БД
│   ├── db_manager.py        # Менеджер БД
│   └── load_config.py       # Загрузка конфигурации
├── sql_scripts/             # SQL скрипты
│   ├── ddl/                 # DDL скрипты (создание таблиц)
│   └── dml/                 # DML скрипты (загрузка данных)
├── files/                   # Исходные данные
├── logs/                    # Логи выполнения
└── archive/                 # Архив обработанных файлов
```

## Установка и запуск

### Предварительные требования

- Python 3.9+
- PostgreSQL 12+
- pip

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Настройка базы данных

1. Создайте базу данных PostgreSQL
2. Отредактируйте `config.json` с вашими параметрами подключения
3. Запустите DDL скрипты для создания таблиц:

```sql
\i sql_scripts/ddl_dml_.sql
```

### Запуск ETL-процесса

```bash
python main.py <date> [--config config.json]
```

**Поддерживаемые форматы даты:**

- `01032021` (DDMMYYYY)
- `01-03-2021` (DD-MM-YYYY)
- `01.03.2021` (DD.MM.YYYY)
- `01/03/2021` (DD/MM/YYYY)

**Примеры запуска:**

```bash
python main.py 01032021
python main.py 01-03-2021 --config my_config.json
```

## Структура данных

### Исходные файлы

Проект обрабатывает следующие типы файлов:

- `transactions_ДДММГГГГ.txt` - транзакции (разделитель `;`)
- `passport_blacklist_ДДММГГГГ.xlsx` - черный список паспортов
- `terminals_ДДММГГГГ.xlsx` - справочник терминалов

### Таблицы базы данных

#### Фактовые таблицы

- `dwh_fact_transactions` - транзакции
- `dwh_fact_passport_blacklist` - черный список паспортов

#### Таблицы измерений (SCD2)

- `dwh_dim_terminals_hist` - терминалы с историей изменений

#### Витрина данных

- `rep_fraud` - отчет по мошенничеству

#### Метаданные

- `meta_load_info` - информация о загрузках
- `meta_last_update` - даты последних обновлений

## Проверки на мошенничество

Проект реализует 4 типа проверок:

### 1. Просроченный/заблокированный паспорт

- Транзакции после истечения срока действия паспорта
- Транзакции с паспортами из черного списка
- Подозрительные случаи: NULL для людей младше 45 лет

### 2. Недействующий договор

- Транзакции после истечения срока действия договора

### 3. Операции в разных городах в течение часа

- Обнаружение подозрительных перемещений между городами

### 4. Попытка подбора суммы

- Анализ последовательности отклоненных транзакций с возрастающими суммами

## ETL-процесс

### Этапы обработки

1. **Extract** - загрузка файлов по дате
2. **Transform** - создание временных таблиц (staging)
3. **Load** - загрузка в фактовые таблицы и измерения
4. **Fraud Detection** - построение витрины мошенничества
5. **Archive** - перемещение файлов в архив

### SCD2 (Slowly Changing Dimensions)

Реализован для таблицы терминалов:

- `effective_from` - дата начала действия записи
- `effective_to` - дата окончания действия записи
- `deleted_flg` - флаг удаления

## Логирование

Проект включает подробное логирование:

- Логи записываются в файлы с timestamp в директории `logs/`
- Дублирование в консоль для мониторинга
- Логирование всех этапов ETL-процесса
- Запись метаданных о загрузках в БД
